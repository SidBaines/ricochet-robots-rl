# Review feedback for research proposal step 1.3
_Exported on 12/09/2025 at 11:18:10 BST from Cursor (1.4.5)_

---

**User**

You are a language model, working as part of a team to implement a research proposal. Please take the time to read the ResearchPlan.md.

You have been tasked with reviewing the work of a colleague who has been tasked with implementing 'step 1.3' of the plan detailed in ResearchPlan.md (note that another colleague has already checked and confirmed that the code is good for the previous steps). You are not to change any code, but instead to review the work and give a list of feedback, ordered roughly from highest importance to lowest. Please go ahead and get started. Be as critical as you like.

---

**Cursor**

I'll scan the environment and related files to assess whether Step 1.3 (Gym interface, seeding, spaces, reset/step signatures, registration) is correctly implemented and consistent with tests/docs. Then I'll provide prioritized feedback.

I finished a focused review of `env/ricochet_env.py` and related modules/tests for Step 1.3 (Gym/Gymnasium interface, spaces, seeding, reset/step signatures, and registration). Now I’ll lay out prioritized feedback.

### High priority
- Consistency of success keys in `info`: You set both `success` and `is_success` on success, but only `is_success` is guaranteed to exist (set to False otherwise). This duplication can confuse downstream consumers. Recommend keeping one canonical key (prefer `is_success`) and documenting it.
- Gymnasium registration completeness: The helper `register_env` registers only `id` and `entry_point`. Many users rely on `max_episode_steps` in the Gym registry to consistently get `TimeLimit` behavior via `gym.make`. You implement internal truncation, which is fine, but consider including `max_episode_steps=self.max_steps` (or a constructor arg) in the registry kwargs for compatibility with standard wrappers.
- Determinism guarantees and seeding docs: The code implements Gymnasium-style seeding via `reset(seed=...)` and stores `episode_seed`, which is good. However, seeding semantics aren’t documented at the class level, and `ensure_solvable` can induce retries that depend on solver results. Add a short class docstring note: “deterministic board generation given the provided seed; solver is deterministic; retries do not add extra randomness beyond RNG draws,” so users know reproducibility expectations.
- Action validation behavior: On invalid action, you raise `GymInvalidAction` when Gymnasium is present and `ValueError` otherwise. Downstream RL libs may not catch `ValueError` consistently for env misuse. Consider always raising the Gymnasium error when available and documenting the fallback exception type when not.

### Medium priority
- Registration import fragility: `entry_point="env.ricochet_env:RicochetRobotsEnv"` assumes the project root is on `PYTHONPATH` (your `tests/conftest.py` does this). For users outside this repo layout, registration may fail. Consider supporting both module path and class reference form (callable entry point), or clearly document “ensure project root is on PYTHONPATH before calling register_env.”
- `TimeLimit.truncated` and internal truncation: You set `info["TimeLimit.truncated"]=True` when truncating internally, which is great. Note this may duplicate `TimeLimit` wrapper behavior if users also wrap with Gym’s `TimeLimit`. Document that external `TimeLimit` is optional and duplicative.
- Symbolic observation Box bounds: You use real grid index ranges for positions with dtype float32. That’s valid, but many RL pipelines expect normalized features. Consider documenting expected scaling (“positions are absolute indices; not normalized”) and providing an option (or wrapper) to normalize symbolic observations.
- Observation channel semantics: Image mode encodes target robot position twice (channel 5 target mask and its dedicated robot channel). That’s reasonable, but should be explicitly documented in `channel_names` doc or class docstring so consumers know there’s duplication by design.
- Legacy `seed(...)` method: You provide it and return a singleton list, consistent with classic Gym. Add a note in docstring that `reset(seed=...)` is the preferred API per Gymnasium, to steer users away from legacy usage.

### Lower priority
- Attempt limit for solvable generation: `ensure_solvable=True` retries up to a hardcoded 50 attempts then raises. Exposing this as a constructor arg (e.g., `ensure_attempt_limit`) would aid robustness for harder configurations. If you prefer not to add the arg, at least document the fixed limit.
- Caching walls: `_cached_wall_obs` is built in `reset` and reused, which is correct for static layouts. In case future code modifies walls mid-episode, a brief comment warning that cached walls assume static edges would prevent subtle bugs.
- Minor naming alignment: You write in docstrings that `info` includes `'target_robot'`, which you do, and `'level_solvable'`, which is `True` only when `ensure_solvable` is used; otherwise it’s `None`. Consider making it consistently `False` when not enforced to simplify client code (or document the `None` tri-state).
- Typing and literals: `ObsMode = Literal["image","symbolic"]` is helpful. Consider adding typed constants for directions in `ricochet_env` mirroring `ricochet_core` (`UP, DOWN, ...`) for clarity when mapping actions in docs/examples.
- Render returns string: Returning an ASCII string in `render()` is fine for `"ascii"` mode. Some callers expect side effects or RGB arrays; a brief doc note “returns a string frame” will set expectations.

### Completeness vs. Step 1.3 requirements
- Gymnasium API compliance: `reset(seed=...) -> (obs, info)` and `step(action) -> (obs, reward, terminated, truncated, info)` are correctly implemented and pass tests.
- Spaces: `observation_space` and `action_space` are defined for both obs modes and `channels_first`. Good.
- Seeding and determinism: Implemented via Gymnasium seeding utilities and `np_random`. Good.
- Registration: Helper provided; see notes above to add `max_episode_steps` and clarify import path assumptions.

If you want, I can draft minimal docstring updates and a short README snippet with usage examples to address the documentation-related items above.

---

**User**

Thanks for your hard work reviewing this code, it's really appreciated! Please can you perform another review - (**important** you'll need to re-read the files, since your in-context memory doesn't have the latest changes). You should assess whether your latest suggestions have been addressed, and also generally compare against the original spec for step 1.3 again.

---

**Cursor**

I'll re-open the environment and tests to check if the previous feedback was addressed and re-verify compliance with Step 1.3.

I re-read the environment and tests to verify your updates and to reassess Step 1.3 compliance. Here’s prioritized feedback, focusing first on whether previous points were addressed, then remaining gaps vs the spec.

### Addressed from last review
- The info success flag is now canonical:
  - Removed duplicate `success`; only `is_success` is set, and always present. Good.
- Determinism and seeding are clearly documented:
  - Added class docstring covering seeding behavior, retries under `ensure_solvable`, and determinism. Good.
- Registration improved:
  - `register_env(env_id, max_episode_steps=...)` now supports setting a time limit in Gym’s registry. Good.
  - README documents registration and import path requirements. Good.
- Symbolic observation scaling clarified:
  - Docstring and README note absolute indices and suggest downstream normalization. Good.
- Observation channel duplication is documented:
  - Docstring explicitly calls out target mask vs robot channel. Good.
- Attempt limit made configurable:
  - New `ensure_attempt_limit` constructor argument; loop uses it. Good.
- Tests updated to use `is_success` and still pass their intent. Good.

### High priority (remaining)
- Consistency of `level_solvable` semantics:
  - `info["level_solvable"]` is `True` when enforced, and `None` otherwise. Consider making this a strict boolean (True/False), and if you need to convey “not enforced,” add a separate flag like `ensure_solvable_enabled` in `info`. Current tri-state can complicate downstream logic.
- Registration entry point portability:
  - `entry_point="env.ricochet_env:RicochetRobotsEnv"` still relies on the project root being on `PYTHONPATH`. README mentions this, which helps. If you want to make it more robust, consider supporting a callable entry point or packaging the module (setup.cfg/pyproject) so users can `pip install -e .`. Not required, but best practice.

### Medium priority
- Invalid action exception consistency:
  - When Gymnasium is available, `InvalidAction` is raised; otherwise `ValueError`. This is acceptable, but consider documenting the fallback explicitly in the class docstring or README so users know what to catch if they run without Gymnasium.
- Time limit duplication caveat:
  - README notes that the env already enforces `max_steps` and to avoid wrapping with `TimeLimit` unless you disable the internal cap. That’s good; optionally, add a one-liner in `register_env` docstring repeating this so users see it where they set `max_episode_steps`.
- Render return type:
  - You return a string for `"ascii"` and `None` for `render_mode=None`. This is documented and fine. If you later add an RGB mode, note the expected dtype/shape in docstrings.

### Low priority/nits
- Channel names property:
  - `channel_names` returns dynamic robot channel names; consider adding this list to `info` on reset when `obs_mode=="image"` so downstream consumers can log and verify channel mappings without accessing the property (optional).
- Solver determinism statement:
  - Class docstring notes solver is deterministic; that’s true for the provided BFS. If you later expose A* modes with non-admissible heuristics, keep this statement accurate (e.g., still deterministic but may be suboptimal).
- Minor doc detail for legacy seeding:
  - You already note “Prefer reset(seed=...)” in `seed()`; that’s good. Optionally mention it in README’s API notes as well.

### Step 1.3 spec check (Gym/Gymnasium API, spaces, seeding, registration)
- Gymnasium API:
  - `reset(seed=...) -> (obs, info)` and `step(...) -> (obs, reward, terminated, truncated, info)` implemented correctly and used by tests. Good.
- Spaces:
  - `observation_space` defined for image and symbolic modes, with `channels_first` support; `action_space` is `Discrete(num_robots*4 + [noop])`. Good.
- Seeding/determinism:
  - Uses Gymnasium seeding, exposes `episode_seed`, and documents behavior. Good.
- Registration:
  - Helper provided with `max_episode_steps` parameter. README includes example; import path caveat documented. Good.

Overall, your updates significantly tightened compliance and documentation. The only substantive behavioral consideration left is the tri-state `level_solvable` value; making it boolean or adding a companion flag would simplify client code. Everything else aligns well with Step 1.3 and common Gymnasium expectations.

I verified the updated files (`env/ricochet_env.py`, tests, README) reflect the changes above and continue to satisfy the intended API.

- I re-opened `env/ricochet_env.py`, tests, and `README.md` to verify that previous feedback was addressed, then compared the implementation to Step 1.3 requirements.

