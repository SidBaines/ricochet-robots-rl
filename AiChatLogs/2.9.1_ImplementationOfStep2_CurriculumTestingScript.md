# Set up curriculum with jupyter script
_Exported on 16/09/2025 at 11:10:02 BST from Cursor (1.4.5)_

---

**User**

Please can you write a short script, using jupyter cell tags '#%%' in the style of 'initial_testing_cells.py', which sets up the curriculum using `puzzle_bank` and the `curriculum_config_example2.json`. It should set up the curriculum as it would be set up in `train_agent.py`, and then print render (in rgb mode) a few examples of environments from each level. 

---

**Cursor**

I'll scan how the curriculum is set up in the training script and the config utilities, then create a small Jupyter-style script that mirrors that setup and renders RGB examples for each level.

I'll create a new Python script with Jupyter-style cells that mirrors the bank curriculum setup from the training script, loads `curriculum_config_example2.json`, and renders a few RGB examples per level using the `puzzle_bank`.

```python
#%%
"""
Bank Curriculum Preview

This Jupyter-style script mirrors the bank-based curriculum setup from `train_agent.py`.
It loads curriculum levels from `curriculum_config_example2.json`, uses the `puzzle_bank`,
and renders a few RGB examples from each level.
"""

import json
from pathlib import Path
from typing import List, Dict, Any

import numpy as np
import matplotlib.pyplot as plt

from env.curriculum import create_bank_curriculum_manager, BankCurriculumWrapper
from env.puzzle_bank import PuzzleBank, SpecKey


#%%
# Configuration
BANK_DIR = str(Path("./puzzle_bank").resolve())
CONFIG_PATH = str(Path("./curriculum_config_example2.json").resolve())
EXAMPLES_PER_LEVEL = 3
OBS_MODE = "rgb_image"
CHANNELS_FIRST = True

# Curriculum thresholds (aligned with train_agent.py defaults)
SUCCESS_RATE_THRESHOLD = 0.8
MIN_EPISODES_PER_LEVEL = 100
SUCCESS_RATE_WINDOW_SIZE = 200
ADVANCEMENT_CHECK_FREQUENCY = 50
VERBOSE = True


#%%
# Load curriculum levels from JSON and convert spec_keys to SpecKey
with open(CONFIG_PATH, "r", encoding="utf-8") as f:
    config_data: Dict[str, Any] = json.load(f)

levels: List[Dict[str, Any]] = config_data.get("levels", [])
for level in levels:
    spec_dict = level["spec_key"]
    if isinstance(spec_dict, dict):
        level["spec_key"] = SpecKey(
            height=spec_dict["height"],
            width=spec_dict["width"],
            num_robots=spec_dict["num_robots"],
            edge_t_per_quadrant=spec_dict["edge_t_per_quadrant"],
            central_l_per_quadrant=spec_dict["central_l_per_quadrant"],
            generator_rules_version=spec_dict.get("generator_rules_version", 1),
        )

print(f"Loaded {len(levels)} curriculum levels from {CONFIG_PATH}")


#%%
# Initialize puzzle bank and curriculum manager
bank = PuzzleBank(BANK_DIR)
bank_manager = create_bank_curriculum_manager(
    bank=bank,
    curriculum_levels=levels,
    success_rate_threshold=SUCCESS_RATE_THRESHOLD,
    min_episodes_per_level=MIN_EPISODES_PER_LEVEL,
    success_rate_window_size=SUCCESS_RATE_WINDOW_SIZE,
    advancement_check_frequency=ADVANCEMENT_CHECK_FREQUENCY,
    verbose=VERBOSE,
)


#%%
# Utility to create a wrapper bound to the manager's current level

def make_wrapper_for_current_level(render_mode: str = "rgb") -> BankCurriculumWrapper:
    return BankCurriculumWrapper(
        bank=bank,
        curriculum_manager=bank_manager,
        obs_mode=OBS_MODE,
        channels_first=CHANNELS_FIRST,
        render_mode=render_mode,
        verbose=VERBOSE,
    )


#%%
# Render a few examples per level in RGB mode
plt.rcParams["figure.figsize"] = (4 * EXAMPLES_PER_LEVEL, 4)

for level_idx, level_spec in enumerate(levels):
    bank_manager.current_level = level_idx
    env = make_wrapper_for_current_level(render_mode="rgb")
    fig, axes = plt.subplots(1, EXAMPLES_PER_LEVEL)
    if EXAMPLES_PER_LEVEL == 1:
        axes = [axes]
    for i in range(EXAMPLES_PER_LEVEL):
        obs, info = env.reset()
        rgb = env.render()
        if isinstance(rgb, np.ndarray):
            axes[i].imshow(rgb)
            axes[i].axis("off")
            title = f"L{level_idx}: {level_spec['name']}\nopt_len={info.get('optimal_length', '?')} robots_moved={info.get('robots_moved', '?')}"
            axes[i].set_title(title, fontsize=9)
        else:
            axes[i].text(0.5, 0.5, "No RGB available", ha="center", va="center")
            axes[i].axis("off")
    fig.suptitle(f"Curriculum Level {level_idx}: {level_spec['name']}")
    plt.tight_layout()
    plt.show()
    env.close()

print("Preview complete.")
```

I created the new Jupyter-style script and will quickly check it for linter issues.

- I added `bank_curriculum_preview.py` that mirrors the bank-based curriculum setup from `train_agent.py`, loads `curriculum_config_example2.json`, and renders a few RGB examples from each curriculum level using the `puzzle_bank`.

How to use:
1) Ensure your bank exists in `./puzzle_bank` (or adjust `BANK_DIR`).
2) Run the script or open it in a Jupyter-like environment. It uses `#%%` cells like `initial_testing_cells.py`.
3) The “Render a few examples per level” cell will display sample RGB boards per level.

Key bits:
```python
# Loads the curriculum JSON and converts spec_key dicts to SpecKey
with open(CONFIG_PATH, "r", encoding="utf-8") as f:
    config_data = json.load(f)
levels = config_data.get("levels", [])
for level in levels:
    spec_dict = level["spec_key"]
    level["spec_key"] = SpecKey(...)

# Creates a bank curriculum manager like train_agent.py
bank = PuzzleBank(BANK_DIR)
bank_manager = create_bank_curriculum_manager(bank=bank, curriculum_levels=levels, ...)

# Iterates levels and renders RGB examples
for level_idx, level_spec in enumerate(levels):
    bank_manager.current_level = level_idx
    env = BankCurriculumWrapper(bank=bank, curriculum_manager=bank_manager, obs_mode="rgb_image", render_mode="rgb", ...)
    obs, info = env.reset()
    rgb = env.render()
    plt.imshow(rgb)
```

- File added: `bank_curriculum_preview.py`
- Uses `OBS_MODE="rgb_image"` and `render_mode="rgb"`; shows optimal length and robots moved in titles.

```python
# Loads the curriculum JSON and converts spec_key dicts to SpecKey
with open(CONFIG_PATH, "r", encoding="utf-8") as f:
    config_data = json.load(f)
levels = config_data.get("levels", [])
for level in levels:
    spec_dict = level["spec_key"]
    level["spec_key"] = SpecKey(...)

# Creates a bank curriculum manager like train_agent.py
bank = PuzzleBank(BANK_DIR)
bank_manager = create_bank_curriculum_manager(bank=bank, curriculum_levels=levels, ...)

# Iterates levels and renders RGB examples
for level_idx, level_spec in enumerate(levels):
    bank_manager.current_level = level_idx
    env = BankCurriculumWrapper(bank=bank, curriculum_manager=bank_manager, obs_mode="rgb_image", render_mode="rgb", ...)
    obs, info = env.reset()
    rgb = env.render()
    plt.imshow(rgb)
```

