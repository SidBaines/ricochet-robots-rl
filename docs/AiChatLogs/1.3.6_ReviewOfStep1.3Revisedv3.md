# Review feedback for research proposal step 1.3
_Exported on 12/09/2025 at 11:11:41 BST from Cursor (1.4.5)_

---

**User**

You are a language model, working as part of a team to implement a research proposal. Please take the time to read the ResearchPlan.md.

You have been tasked with reviewing the work of a colleague who has been tasked with implementing 'step 1.3' of the plan detailed in ResearchPlan.md (note that another colleague has already checked and confirmed that the code is good for the previous steps). You are not to change any code, but instead to review the work and give a list of feedback, ordered roughly from highest importance to lowest. Please go ahead and get started. Be as critical as you like.

---

**Cursor**

I'll scan the environment and related files to assess whether Step 1.3 (Gym interface, seeding, spaces, reset/step signatures, registration) is correctly implemented and consistent with tests/docs. Then I'll provide prioritized feedback.

I finished a focused review of `env/ricochet_env.py` and related modules/tests for Step 1.3 (Gym/Gymnasium interface, spaces, seeding, reset/step signatures, and registration). Now I’ll lay out prioritized feedback.

### High priority
- Consistency of success keys in `info`: You set both `success` and `is_success` on success, but only `is_success` is guaranteed to exist (set to False otherwise). This duplication can confuse downstream consumers. Recommend keeping one canonical key (prefer `is_success`) and documenting it.
- Gymnasium registration completeness: The helper `register_env` registers only `id` and `entry_point`. Many users rely on `max_episode_steps` in the Gym registry to consistently get `TimeLimit` behavior via `gym.make`. You implement internal truncation, which is fine, but consider including `max_episode_steps=self.max_steps` (or a constructor arg) in the registry kwargs for compatibility with standard wrappers.
- Determinism guarantees and seeding docs: The code implements Gymnasium-style seeding via `reset(seed=...)` and stores `episode_seed`, which is good. However, seeding semantics aren’t documented at the class level, and `ensure_solvable` can induce retries that depend on solver results. Add a short class docstring note: “deterministic board generation given the provided seed; solver is deterministic; retries do not add extra randomness beyond RNG draws,” so users know reproducibility expectations.
- Action validation behavior: On invalid action, you raise `GymInvalidAction` when Gymnasium is present and `ValueError` otherwise. Downstream RL libs may not catch `ValueError` consistently for env misuse. Consider always raising the Gymnasium error when available and documenting the fallback exception type when not.

### Medium priority
- Registration import fragility: `entry_point="env.ricochet_env:RicochetRobotsEnv"` assumes the project root is on `PYTHONPATH` (your `tests/conftest.py` does this). For users outside this repo layout, registration may fail. Consider supporting both module path and class reference form (callable entry point), or clearly document “ensure project root is on PYTHONPATH before calling register_env.”
- `TimeLimit.truncated` and internal truncation: You set `info["TimeLimit.truncated"]=True` when truncating internally, which is great. Note this may duplicate `TimeLimit` wrapper behavior if users also wrap with Gym’s `TimeLimit`. Document that external `TimeLimit` is optional and duplicative.
- Symbolic observation Box bounds: You use real grid index ranges for positions with dtype float32. That’s valid, but many RL pipelines expect normalized features. Consider documenting expected scaling (“positions are absolute indices; not normalized”) and providing an option (or wrapper) to normalize symbolic observations.
- Observation channel semantics: Image mode encodes target robot position twice (channel 5 target mask and its dedicated robot channel). That’s reasonable, but should be explicitly documented in `channel_names` doc or class docstring so consumers know there’s duplication by design.
- Legacy `seed(...)` method: You provide it and return a singleton list, consistent with classic Gym. Add a note in docstring that `reset(seed=...)` is the preferred API per Gymnasium, to steer users away from legacy usage.

### Lower priority
- Attempt limit for solvable generation: `ensure_solvable=True` retries up to a hardcoded 50 attempts then raises. Exposing this as a constructor arg (e.g., `ensure_attempt_limit`) would aid robustness for harder configurations. If you prefer not to add the arg, at least document the fixed limit.
- Caching walls: `_cached_wall_obs` is built in `reset` and reused, which is correct for static layouts. In case future code modifies walls mid-episode, a brief comment warning that cached walls assume static edges would prevent subtle bugs.
- Minor naming alignment: You write in docstrings that `info` includes `'target_robot'`, which you do, and `'level_solvable'`, which is `True` only when `ensure_solvable` is used; otherwise it’s `None`. Consider making it consistently `False` when not enforced to simplify client code (or document the `None` tri-state).
- Typing and literals: `ObsMode = Literal["image","symbolic"]` is helpful. Consider adding typed constants for directions in `ricochet_env` mirroring `ricochet_core` (`UP, DOWN, ...`) for clarity when mapping actions in docs/examples.
- Render returns string: Returning an ASCII string in `render()` is fine for `"ascii"` mode. Some callers expect side effects or RGB arrays; a brief doc note “returns a string frame” will set expectations.

### Completeness vs. Step 1.3 requirements
- Gymnasium API compliance: `reset(seed=...) -> (obs, info)` and `step(action) -> (obs, reward, terminated, truncated, info)` are correctly implemented and pass tests.
- Spaces: `observation_space` and `action_space` are defined for both obs modes and `channels_first`. Good.
- Seeding and determinism: Implemented via Gymnasium seeding utilities and `np_random`. Good.
- Registration: Helper provided; see notes above to add `max_episode_steps` and clarify import path assumptions.

If you want, I can draft minimal docstring updates and a short README snippet with usage examples to address the documentation-related items above.

